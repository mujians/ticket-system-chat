<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎫 Sistema Gestione Tickets</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 300;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover { transform: translateY(-2px); }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .open { color: #dc3545; }
        .resolved { color: #28a745; }
        .total { color: #007bff; }
        .today { color: #fd7e14; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        
        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .tickets-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .ticket {
            border-bottom: 1px solid #eee;
            padding: 20px;
            transition: background-color 0.2s;
        }
        
        .ticket:hover { background: #f8f9fa; }
        .ticket:last-child { border-bottom: none; }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .ticket-id {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1rem;
        }
        
        .ticket-meta {
            font-size: 0.85rem;
            color: #666;
        }
        
        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .priority-low { background: #d4edda; color: #155724; }
        .priority-medium { background: #fff3cd; color: #856404; }
        .priority-high { background: #f8d7da; color: #721c24; }
        .priority-urgent { background: #dc3545; color: white; }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-open { background: #f8d7da; color: #721c24; }
        .status-resolved { background: #d4edda; color: #155724; }
        .status-closed { background: #d1ecf1; color: #0c5460; }
        
        .ticket-question {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
            font-style: italic;
        }
        
        .ticket-response {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .ticket-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .respond-form {
            display: none;
            margin-top: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .respond-form textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }
        
        .respond-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 6px;
        }
        
        .pagination button:hover { background: #f8f9fa; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination button.active { background: #007bff; color: white; }
        
        @media (max-width: 768px) {
            .ticket-header { flex-direction: column; gap: 10px; }
            .controls-row { flex-direction: column; align-items: stretch; }
            .ticket-actions { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🎫 Sistema Gestione Tickets</h1>
        </div>
    </div>

    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number total" id="totalTickets">-</div>
                <div class="stat-label">Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number open" id="openTickets">-</div>
                <div class="stat-label">Aperti</div>
            </div>
            <div class="stat-card">
                <div class="stat-number resolved" id="resolvedTickets">-</div>
                <div class="stat-label">Risolti</div>
            </div>
            <div class="stat-card">
                <div class="stat-number today" id="todayTickets">-</div>
                <div class="stat-label">Oggi</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-row">
                <select id="statusFilter">
                    <option value="">Tutti gli status</option>
                    <option value="open">Aperti</option>
                    <option value="in_progress">In lavorazione</option>
                    <option value="resolved">Risolti</option>
                    <option value="closed">Chiusi</option>
                </select>
                
                <select id="sortBy">
                    <option value="created_at">Data creazione</option>
                    <option value="priority">Priorità</option>
                    <option value="status">Status</option>
                </select>
                
                <select id="sortOrder">
                    <option value="desc">Decrescente</option>
                    <option value="asc">Crescente</option>
                </select>
                
                <button class="btn" onclick="loadTickets()">🔄 Aggiorna</button>
                <button class="btn btn-success" onclick="testNotifications()">🧪 Test Notifiche</button>
            </div>
        </div>

        <!-- Tickets -->
        <div class="tickets-container">
            <div id="ticketsContent" class="loading">
                <div class="spinner"></div>
                <p>Caricamento tickets...</p>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        
        // Load tickets on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadTickets();
            
            // Set up filters
            document.getElementById('statusFilter').addEventListener('change', () => { currentPage = 1; loadTickets(); });
            document.getElementById('sortBy').addEventListener('change', () => { currentPage = 1; loadTickets(); });
            document.getElementById('sortOrder').addEventListener('change', () => { currentPage = 1; loadTickets(); });
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/tickets/admin/stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalTickets').textContent = stats.total || 0;
                    document.getElementById('openTickets').textContent = stats.open || 0;
                    document.getElementById('resolvedTickets').textContent = stats.resolved || 0;
                    document.getElementById('todayTickets').textContent = stats.today || 0;
                }
            } catch (err) {
                console.error('Errore caricamento statistiche:', err);
            }
        }

        async function loadTickets() {
            const content = document.getElementById('ticketsContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Caricamento tickets...</p></div>';
            
            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 10,
                    status: document.getElementById('statusFilter').value,
                    sort: document.getElementById('sortBy').value,
                    order: document.getElementById('sortOrder').value
                });
                
                const response = await fetch(`/api/tickets?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    displayTickets(result.data);
                    updatePagination(result.pagination);
                } else {
                    content.innerHTML = '<div class="empty-state"><h3>Errore caricamento</h3><p>Impossibile caricare i tickets</p></div>';
                }
            } catch (err) {
                console.error('Errore caricamento tickets:', err);
                content.innerHTML = '<div class="empty-state"><h3>Errore</h3><p>Connessione fallita</p></div>';
            }
        }

        function displayTickets(tickets) {
            const content = document.getElementById('ticketsContent');
            
            if (tickets.length === 0) {
                content.innerHTML = '<div class="empty-state"><h3>📭 Nessun ticket</h3><p>Non ci sono tickets da mostrare</p></div>';
                return;
            }
            
            content.innerHTML = tickets.map(ticket => `
                <div class="ticket">
                    <div class="ticket-header">
                        <div>
                            <span class="ticket-id">#${ticket.id}</span>
                            <span class="priority-badge priority-${ticket.priority || 'medium'}">${(ticket.priority || 'medium').toUpperCase()}</span>
                            <span class="status-badge status-${ticket.status}">${getStatusText(ticket.status)}</span>
                        </div>
                        <div class="ticket-meta">
                            <div>📅 ${new Date(ticket.created_at).toLocaleString('it-IT')}</div>
                            <div>👤 ${ticket.user_id || 'Anonimo'}</div>
                            ${ticket.user_email ? `<div>📧 ${ticket.user_email}</div>` : ''}
                            ${ticket.user_phone ? `<div>📞 ${ticket.user_phone}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="ticket-question">
                        <strong>❓ Domanda:</strong><br>
                        ${ticket.question}
                    </div>
                    
                    ${ticket.response ? `
                        <div class="ticket-response">
                            <strong>💬 Risposta:</strong><br>
                            ${ticket.response}<br>
                            <small style="color: #666; margin-top: 10px; display: block;">
                                Risposto il ${new Date(ticket.responded_at).toLocaleString('it-IT')}
                            </small>
                        </div>
                    ` : ''}
                    
                    <div class="ticket-actions">
                        ${ticket.status === 'open' ? `
                            <button class="btn btn-success" onclick="toggleResponseForm(${ticket.id})">💬 Rispondi</button>
                            <button class="btn" onclick="updateStatus(${ticket.id}, 'in_progress')">🔄 In Lavorazione</button>
                        ` : ''}
                        
                        ${ticket.status === 'in_progress' ? `
                            <button class="btn btn-success" onclick="toggleResponseForm(${ticket.id})">💬 Rispondi</button>
                        ` : ''}
                        
                        ${ticket.status === 'resolved' ? `
                            <button class="btn" onclick="updateStatus(${ticket.id}, 'closed')">📁 Chiudi</button>
                            <button class="btn" onclick="updateStatus(${ticket.id}, 'open')">🔄 Riapri</button>
                        ` : ''}
                        
                        <button class="btn btn-danger" onclick="deleteTicket(${ticket.id})">🗑️ Elimina</button>
                    </div>
                    
                    <div class="respond-form" id="respondForm${ticket.id}">
                        <textarea id="response${ticket.id}" placeholder="Scrivi la tua risposta qui..."></textarea>
                        <div class="respond-actions">
                            <button class="btn btn-success" onclick="sendResponse(${ticket.id})">📤 Invia Risposta</button>
                            <button class="btn" onclick="toggleResponseForm(${ticket.id})">❌ Annulla</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            totalPages = pagination.pages;
            currentPage = pagination.page;
            
            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>← Precedente</button>`;
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `<button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            
            // Next button
            html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Successiva →</button>`;
            
            paginationEl.innerHTML = html;
        }

        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                loadTickets();
            }
        }

        function toggleResponseForm(ticketId) {
            const form = document.getElementById(`respondForm${ticketId}`);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function sendResponse(ticketId) {
            const response = document.getElementById(`response${ticketId}`).value.trim();
            
            if (!response) {
                alert('Inserisci una risposta');
                return;
            }
            
            try {
                const result = await fetch(`/api/tickets/${ticketId}/respond`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ response })
                });
                
                const data = await result.json();
                
                if (data.success) {
                    alert('✅ Risposta inviata con successo!');
                    loadStats();
                    loadTickets();
                } else {
                    alert('❌ Errore invio risposta: ' + data.error);
                }
            } catch (err) {
                alert('❌ Errore: ' + err.message);
            }
        }

        async function updateStatus(ticketId, status) {
            try {
                const result = await fetch(`/api/tickets/${ticketId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                
                const data = await result.json();
                
                if (data.success) {
                    loadStats();
                    loadTickets();
                } else {
                    alert('❌ Errore aggiornamento: ' + data.error);
                }
            } catch (err) {
                alert('❌ Errore: ' + err.message);
            }
        }

        async function deleteTicket(ticketId) {
            if (!confirm('Sei sicuro di voler eliminare questo ticket?')) return;
            
            try {
                const result = await fetch(`/api/tickets/${ticketId}`, {
                    method: 'DELETE'
                });
                
                const data = await result.json();
                
                if (data.success) {
                    loadStats();
                    loadTickets();
                } else {
                    alert('❌ Errore eliminazione: ' + data.error);
                }
            } catch (err) {
                alert('❌ Errore: ' + err.message);
            }
        }

        async function testNotifications() {
            if (!confirm('Vuoi inviare delle notifiche di test?')) return;
            
            try {
                // Test creating a ticket
                const testTicket = {
                    user_id: 'test_user',
                    user_email: 'test@example.com',
                    user_phone: '+393331234567',
                    question: 'Questa è una domanda di test per verificare il sistema di notifiche.',
                    priority: 'medium',
                    category: 'test'
                };
                
                const response = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testTicket)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Ticket di test creato! Controlla le notifiche email/WhatsApp.');
                    loadStats();
                    loadTickets();
                } else {
                    alert('❌ Errore creazione ticket test: ' + result.error);
                }
            } catch (err) {
                alert('❌ Errore: ' + err.message);
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                open: 'APERTO',
                in_progress: 'IN LAVORAZIONE',
                resolved: 'RISOLTO',
                closed: 'CHIUSO'
            };
            return statusTexts[status] || status.toUpperCase();
        }
    </script>
</body>
</html>